---
layout: post
title: "Practical Malware Analysis, Lab 1-1"
description: "Walkthrough of the Lab 1-1 from the book Practical Malware Analysis"
date: 2017-05-07
tags: malware
show_social: true
comments: true
---

This is a walkthrough of the Lab 1-1 from the book _Practical Malware Analysis_: basic static malware analysis techniques are applied to samples `Lab01-01.exe` and `Lab01-01.dll`.

<!--more-->

_Please note that there may be many different (and even better) ways to solve this lab, so the one described here is just my solution._

Let's start!


> 1) Upload the files to [VirusTotal](http://www.virustotal.com) and view the reports. Does either file match any existing antivirus signatures?

I prefer to compute the hashes first and then look for that hashes on VirusTotal.

**Lab01-01.exe**

MD5 | bb7425b82141a1c0f7d60e5106676bb1
SHA1 | 9dce39ac1bd36d877fdb0025ee88fdaff0627cdb
SHA256 | 58898bd42c5bd3bf9b1389f0eee5b39cd59180e8370eb9ea838a0b327bd6fe47

**Lab01-01.dll**

MD5 | 290934c61de9176ad682ffdd65f0a669
SHA1 | a4b35de71ca20fe776dc72d12fb2886736f43c22
SHA256 | f50e42c8dfaab649bde0398867e930b86c2a599e8db83b8260393082268f2dba

The VirusTotal reports are available at the following links:

* [Lab01-01.exe](https://www.virustotal.com/en/file/58898bd42c5bd3bf9b1389f0eee5b39cd59180e8370eb9ea838a0b327bd6fe47/analysis/)

* [Lab01-01.dll](https://www.virustotal.com/en/file/f50e42c8dfaab649bde0398867e930b86c2a599e8db83b8260393082268f2dba/analysis/)

At present date both files are identified as malicious:

![VirusTotal Lab01-01.exe](/media/img/lab-01-01/virustotal_exe.png)

![VirusTotal Lab01-01.dll](/media/img/lab-01-01/virustotal_dll.png)


> 2) When were these files compiled?

The compilation time can be seen by opening the files with [PEview](http://wjradburn.com/software/PEview.zip) and looking under: `IMAGE_NT_HEADERS` / `IMAGE_FILE_HEADER` / `TimeDateStamp`:

Time Date Stamp |
------------ | -------------
Lab01-01.exe | 2010/12/19 Sun 16:16:19 UTC
Lab01-01.dll | 2010/12/19 Sun 16:16:38 UTC

![TimeDateStamp with PEview](/media/img/lab-01-01/datetimestamp_peview.png)

> 3) Are there any indications that either of these files is packed or obfuscated? If so, what are these indicators?

We can analyze the files with PEiD or [ExeinfoPE](http://exeinfo.pe.hu/) and see that there is no indication of them being either packed or obfuscated.

![PEiD](/media/img/lab-01-01/packed_peid_exe.png)

![ExeinfoPE](/media/img/lab-01-01/packed_exinfope_dll.png)

A good sign that neither one is packed is that both contains many meaningful strings.

```
C:\Users\REM\Desktop\ex> strings2 -nh Lab01-01.exe

!This program cannot be run in DOS mode.
$
Richm
.text
`.rdata
@.data
UVWj
@jjj
@jjj
ugh 0@
_^][
SUVW
h00@
_^][
SUVW
@jjj
@jjj
h|0@
D$Pj
l$\u
S$QWR
FxRVP
D$$3
D$8R
t$<f
p0@
t0@
x0@
T$PR
hL0@
h|0@
hD0@
_^]3
hp @
 SVW
%8 @
%D @
%\ @
%` @
CloseHandle
UnmapViewOfFile
IsBadReadPtr
MapViewOfFile
CreateFileMappingA
CreateFileA
FindClose
FindNextFileA
FindFirstFileA
CopyFileA
KERNEL32.dll
malloc
exit
MSVCRT.dll
_exit
_XcptFilter
__p___initenv
__getmainargs
_initterm
__setusermatherr
_adjust_fdiv
__p__commode
__p__fmode
__set_app_type
_except_handler3
_controlfp
_stricmp
kerne132.dll
kernel32.dll
.exe
C:\*
C:\windows\system32\kerne132.dll
Kernel32.
Lab01-01.dll
C:\Windows\System32\Kernel32.dll
WARNING_THIS_WILL_DESTROY_YOUR_MACHINE
```

```
C:\Users\REM\Desktop\ex> strings2 -nh Lab01-01.dll

!This program cannot be run in DOS mode.
$
Rich
.text
`.rdata
@.data
.reloc
L$xQh
IQh `
L$4PQj
D$\D
t       WVS
NWVS
u7WPS
u&WVS
_^[]
CloseHandle
Sleep
CreateProcessA
CreateMutexA
OpenMutexA
KERNEL32.dll
WS2_32.dll
strncmp
MSVCRT.dll
free
_initterm
malloc
_adjust_fdiv
exec
sleep
hello
127.26.152.13
SADFHUHF
/0I0[0h0p0
141G1[1l1
1Y2a2g2r2
3!3}3
```

> 4) Do any imports hint at what this malware does? If so, which imports are they?

Imports can be viewed using either IDA Pro or Dependency Walker. If the sample is not packed - as in this case - imports can also be viewed by dumping the strings.

The sample `Lab01-01.exe` imports the following functions from `KERNEL32.dll`:
```
CloseHandle
CopyFileA
CreateFileA
CreateFileMappingA
FindClose
FindFirstFileA
FindNextFileA
IsBadReadPtr
MapViewOfFile
UnmapViewOfFile
```
![Imports with Dependency Walker](/media/img/lab-01-01/imports_dependencywalker_exe.png)

The sample `Lab01-01.dll` imports functions from `KERNEL32.dll` and from `WS2_32.dll`.
These are the ones from `KERNEL32.dll`:

```
CloseHandle
CreateProcessA
CreateMutexA
OpenMutexA
Sleep
```

Functions from `WS2_32.dll` are imported by ordinal so their names are not immediately visible in Dependency Walker. It suffices to search the ordinal value in the lower pane that shows all functions that are importable from the DLL. For instance, the function with ordinal `0x4` is `connect`:

![Imports with Dependency Walker](/media/img/lab-01-01/imports_dependencywalker_dll_ws2.png)

The names of the functions imported by ordinal are automatically showed within IDA Pro. Here is the complete list of import for `Lab01-01.dll`:

![Imports with IDA Pro](/media/img/lab-01-01/imports_ida_dll.png)


> 5. Are there any other files or host-based indicators that you could look for on infected systems?

File:  Lab01-01.dll
File:  C:\windows\system32\kerne132.dll
Mutex: SADFHUHF


Search for text (Alt+T)

![Mutex](/media/img/lab-01-01/mutex_ida.png)


##6. What network-based indicators could be used to find this malware on
infected machines?


127.26.152.13



##7. What would you guess is the purpose of these files?



## Lab01-01.exe

From the strings output it doesn't seem that this executable is packed.

There are some interesting strings to notice. A few are library functions that are called.
I can deduce that the malware is searching for files (FindFirstFile, FindNextFile), maybe those ending in .exe; it is creating and copying some file (CreateFile, CopyFile); it is getting a map of an existing file (MapViewOfFile) which it may be read from or write to.
Additionally it is using the DLL Lab01-01.dll which may be copied to kerne132.dll in C:\windows\system32\ (a name that resemble the legit kernel32.dll).

CloseHandle
UnmapViewOfFile
IsBadReadPtr
MapViewOfFile
CreateFileMappingA
CreateFileA
FindClose
FindNextFileA
FindFirstFileA
CopyFileA

kerne132.dll
.exe
C:\*
C:\windows\system32\kerne132.dll
Lab01-01.dll




## Lab01-01.dll

CloseHandle
Sleep
CreateProcessA
CreateMutexA
OpenMutexA

exec
sleep
hello

127.26.152.13
SADFHUHF
