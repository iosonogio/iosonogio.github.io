---
layout: post
title: "Practical Malware Analysis, Lab 1-2"
description: "Walkthrough of the Lab 1-2 from the book Practical Malware Analysis"
date: 2017-05-14
tags: malware
show_social: true
comments: true
---

This is a walkthrough of the Lab 1-2 from the book _Practical Malware Analysis_: basic static malware analysis techniques are applied to the sample `Lab01-02.exe`.

<!--more-->

_Please note that there may be many different (and even better) ways to solve this lab, so the one described here is just my solution._

The [samples for this lab can be downloaded from here](https://github.com/iosonogio/PracticalMalwareAnalysis-Labs).

Let's start!


> ## 1) Upload the Lab01-02.exe file to VirusTotal. Does it match any existing antivirus definitions?

I will compute the hash first and then look for that hash on [VirusTotal](http://www.virustotal.com).

**Lab01-02.exe**

MD5 | 8363436878404da0ae3e46991e355b83
SHA1 | 5a016facbcb77e2009a01ea5c67b39af209c3fcb
SHA256 | c876a332d7dd8da331cb8eee7ab7bf32752834d4b2b54eaa362674a2a48f64a6

The VirusTotal report is available at the following links:

* [Lab01-02.exe](https://www.virustotal.com/en/file/c876a332d7dd8da331cb8eee7ab7bf32752834d4b2b54eaa362674a2a48f64a6/analysis/)

At present date the file is identified as malicious:

![VirusTotal Lab01-02.exe](/media/pma/lab-01-02/packed_virustotal.png)


> ## 2) Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.

We can analyze the file with [PEiD](https://www.aldeid.com/wiki/PEiD) and see that it's been packed with [UPX](https://upx.github.io/).

![PEiD](/media/pma/lab-01-02/packed_peid.png)

Looking at the PE sections also reveals signs of packing.

**Lab01-02.exe**

![PE sections](/media/pma/lab-01-02/packed_sections.png)

Section | Virtual Size | Raw Size
----- | ----- | -----
UPX0 | 4000 | 0
UPX1 | 1000 | 600
UPX2 | 1000 | 200

Sections names also indicate that UPX packer was probably used; sections sizes in memory and on disk have suspicious values, for instance the `UPX0` section has a size of 0 bytes on disk whereas its size in memory is 0x4000 bytes.

Additionally, the `UPX0` section, the largest one, is flagged as executable: the original unpacked code probably belongs to here. Executable sections have the `IMAGE_SCN_MEM_EXECUTE` characteristic set. The following are two screenshots, the first of [PEview](http://wjradburn.com/software/PEview.zip) the second of [ExeinfoPE](http://exeinfo.pe.hu/), showing that characteristic:

![PEview showing executable section](/media/pma/lab-01-02/exec_section_peview.png)

![ExeinfoPE showing executable section](/media/pma/lab-01-02/exec_section_exinfope.png)


An examination of the strings contained in the executable also shows signs of packing: there are references to UPX and there seem to be only a few imports.

```
C:\malwarelab>strings2 -nh Lab01-02.exe
!This program cannot be run in DOS mode.
$
Rich
UPX0
UPX1
UPX2
3.04

a\`Y
|k
(23h
MalService
sHGL345
http://w
warean
ysisbook.co
om#Int6net Explo!r 8FEI
SystemTimeToFile
GetMo
*Waitab'r
Process
OpenMu$x
ZSB+
ForS
ObjectU4
Th
[Vrtb
CtrlDisp ch
Xcpt
mArg
5nm@_
t_fd
dlI37n
olfp
dW|6
lB`.rd
XPTPSW
KERNEL32.DLL
ADVAPI32.dll
MSVCRT.dll
WININET.dll
LoadLibraryA
GetProcAddress
VirtualProtect
VirtualAlloc
VirtualFree
ExitProcess
CreateServiceA
exit
InternetOpenA
```


 LoadLibrary , GetProcAddress , VirtualAlloc

Let's try to unpack the sample with UPX:

```
C:\malwarelab> upx -d Lab01-02.exe -o Lab01-02.exe.unpacked
```

Opening the new executable with PEiD it doesn't appear as packed anymore.

![PEiD](/media/pma/lab-01-02/unpacked_peid.png)

We can get the correct sections information now:

**Lab01-02.exe.unpacked**

![PE sections unpacked](/media/pma/lab-01-02/unpacked_sections.png)

Section | Virtual Size | Raw Size
----- | ----- | -----
.text | 2Dc | 1000
.rdata | 372 | 1000
.data | 8C | 1000

The unpacked executable contains much more meaningful strings:

```
C:\malwarelab> strings2 -nh Lab01-02.exe.unpacked
!This program cannot be run in DOS mode.
$
Rich
.text
`.rdata
@.data
h(0@
Vh(0@
@jjjj
L$,j
@jjj
@jjj
=0 @
hT0@
=p @
h00@
 SVW
|0@
x0@
=l0@
5p0@
%< @
%L @
%d @
%h @
KERNEL32.DLL
ADVAPI32.dll
MSVCRT.dll
WININET.dll
SystemTimeToFileTime
GetModuleFileNameA
CreateWaitableTimerA
ExitProcess
OpenMutexA
SetWaitableTimer
WaitForSingleObject
CreateMutexA
CreateThread
CreateServiceA
StartServiceCtrlDispatcherA
OpenSCManagerA
_exit
_XcptFilter
exit
__p___initenv
__getmainargs
_initterm
__setusermatherr
_adjust_fdiv
__p__commode
__p__fmode
__set_app_type
_except_handler3
_controlfp
InternetOpenUrlA
InternetOpenA
MalService
Malservice
HGL345
http://www.malwareanalysisbook.com
Internet Explorer 8.0
```

VirusTotal is reporting the unpacked sample as malicious as well:

![VirusTotal Lab01-02.exe](/media/pma/lab-01-02/unpacked_virustotal.png)

* [Lab01-02.exe.unpacked](https://www.virustotal.com/en/file/8bcbe24949951d8aae6018b87b5ca799efe47aeb623e6e5d3665814c6d59aeae/analysis/)

And these are the hashes:

**Lab01-02.exe.unpacked**

MD5 | ae4ca70697df5506bc610172cfc288e7
SHA1 | 31e8a82e497058ff14049cf283b337ec51504819
SHA256 | 8bcbe24949951d8aae6018b87b5ca799efe47aeb623e6e5d3665814c6d59aeae


> ## 3) Do any imports hint at this programâ€™s functionality? If so, which imports are they and what do they tell you?




CreateMutex

CreateService

InternetOpen
InternetOpenUrl


InternetOpen
https://msdn.microsoft.com/it-it/library/windows/desktop/aa385096(v=vs.85).aspx







Since the samples are not packed the imports can be viewed either with [Dependency Walker](http://www.dependencywalker.com/), IDA Pro or even by examining the strings contained in the samples.

The sample `Lab01-01.exe` imports the following functions from `KERNEL32.dll`:

```
CloseHandle
CopyFileA
CreateFileA
CreateFileMappingA
FindClose
FindFirstFileA
FindNextFileA
IsBadReadPtr
MapViewOfFile
UnmapViewOfFile
```

This is the same list as showed in the upper right pane of Dependency Walker:

![Imports with Dependency Walker](/media/pma/lab-01-01/imports_dependencywalker_exe.png)

Imports from `MSVCRT.dll` are functions that are included in nearly every executable as wrapper code added by the compiler, so they are not of much interest.

The sample `Lab01-01.dll` imports functions from `KERNEL32.dll` and `WS2_32.dll`.

These are the functions imported from `KERNEL32.dll`:

```
CloseHandle
CreateMutexA
CreateProcessA
OpenMutexA
Sleep
```

The functions from `WS2_32.dll` are imported _by ordinal_ so their names are not immediately visible in Dependency Walker. In order to find their names, it suffices to look for the ordinal value in the lower pane that shows all importable functions. For instance, the function with ordinal `0x4` is `connect`:

![Imports with Dependency Walker](/media/pma/lab-01-01/imports_dependencywalker_dll_ws2.png)

The names of the functions imported by ordinal are automatically showed within IDA Pro. Here is the complete list of imports for `Lab01-01.dll`:

![Imports with IDA Pro](/media/pma/lab-01-01/imports_ida_dll.png)

So these are the functions imported by `Lab01-01.dll` from `WS2_32.dll`:

```
closesocket
connect
htons
inet_addr
recv
send
shutdown
socket
WSACleanup
WSAStartup
```

> ## 5) What host- or network-based indicators could be used to identify this malware on infected machines?



* Service: `Malservice`
* Mutex: `HGL345`
* URL: `http://www.malwareanalysisbook.com` with User-Agent: `Internet Explorer 8.0`












By examining the strings from both samples, I can identify two references to file names that can be used as host-based indicators:

* File: `Lab01-01.dll`
* File: `C:\windows\system32\kerne132.dll`

Notice the name `kernel132.dll` (with a **1**) trying to disguise itself as the legitimate `kernel32.dll` (with an **l**).

The string `SADFHUHF` appears to be the name of a mutex. A mutex is often used by malware as an infection mark, that is to check if another instance of the same malware is already running on a system.
Searching for `SADFHUHF` in IDA Pro (press <kbd>Alt</kbd>+<kbd>T</kbd> to search for text) confirms this hypothesis, as apparent from the following image:

![Mutex](/media/pma/lab-01-01/mutex_ida.png)

So the name of the mutex is an additional host-based indicator:

* Mutex: `SADFHUHF`


> ## 6) What network-based indicators could be used to find this malware on
infected machines?

By examining the strings in `Lab01-01.dll` I can identify this network-based indicator:

* 127.26.152.13


> ## 7) What would you guess is the purpose of these files?

By examining the imported functions my guess is that this malware searches for (`FindFirstFile`, `FindNextFile`) and manipulates (`CopyFile`, `CreateFile`) files. It also gets a map of an existing file into memory (`MapViewOfFile`) making it accessible for reading or writing; this function can be used to read and modify PE files thus avoiding using `WriteFile`. The executable uses the DLL `Lab01-01.dll` which is probably copied to `C:\windows\system32\kerne132.dll`, a name resembling the legit `kernel32.dll`.

The malware communicates with the remote IP `127.26.152.13`. The function `Sleep` makes me think that after infecting a system the malware sits waiting for commands from the remote IP; the strings `exec`, `sleep`, `hello` seems to be the commands that can be sent to the malware.

That's all for this lab!
